using Microsoft.Extensions.FileSystemGlobbing;
using Microsoft.Extensions.Logging;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace MalwarebytesService
{
    public class FileSystemWatcherService
    {
        private readonly FileSystemWatcher _watchFolder;
        private readonly ILogger _logger;

        public FileSystemWatcherService(ILogger<WindowsBackgroundService> logger, IConfiguration config)
        {
            _watchFolder = new FileSystemWatcher();
            _logger = logger;
            try
            {
                var folders = config.GetSection("foldersToWatch").Get<string[]>();
                if (!folders.Any())
                {
                    _logger.LogInformation($"No folders where added");
                }
                else
                {
                    foreach (var folder in folders)
                    {
                        _logger.LogInformation($"Adding {folder} to watcher");

                        StartActivityMonitoring(folder);


                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"uh oh, something went wrong: {ex.Message}");
            }


        }

        private void StartActivityMonitoring(string sPath)
        {
            _watchFolder.Path = sPath;
            _watchFolder.IncludeSubdirectories = true;

            _watchFolder.NotifyFilter = NotifyFilters.Attributes |
            NotifyFilters.CreationTime |
            NotifyFilters.DirectoryName |
            NotifyFilters.FileName |
            NotifyFilters.LastAccess |
            NotifyFilters.LastWrite |
            NotifyFilters.Security |
            NotifyFilters.Size;

            _watchFolder.Changed += new FileSystemEventHandler(OnChanged);
            _watchFolder.Created += new FileSystemEventHandler(OnChanged);
            _watchFolder.Deleted += new FileSystemEventHandler(OnChanged);

            _watchFolder.Renamed += new System.IO.RenamedEventHandler(OnRenamed);

            _watchFolder.EnableRaisingEvents = true;

        }
        private void OnChanged(object sender, System.IO.FileSystemEventArgs e)
        {
            switch (e.ChangeType)
            {
                case WatcherChangeTypes.Changed:
                    _logger.LogInformation($"File {e.FullPath} has been modified\r\n");

                    break;
                case WatcherChangeTypes.Created:
                    _logger.LogInformation($"File {e.FullPath} has been created\r\n");

                    break;
                case WatcherChangeTypes.Deleted:
                    _logger.LogInformation($"File {e.FullPath} has been deleted\r\n");

                    break;
                default: // Another action
                    break;
            }
        }
        public void OnRenamed(object source, RenamedEventArgs e)
        {
            // Specify what is done when a file is renamed.  
            _logger.LogInformation($"{e.OldFullPath} renamed to {e.FullPath}");
        }

    }

}
